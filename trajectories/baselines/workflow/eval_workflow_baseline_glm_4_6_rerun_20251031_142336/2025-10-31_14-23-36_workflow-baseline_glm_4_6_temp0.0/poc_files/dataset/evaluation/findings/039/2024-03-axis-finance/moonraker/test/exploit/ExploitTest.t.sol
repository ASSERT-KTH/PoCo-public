// SPDX-License-Identifier: BUSL-1.1
pragma solidity 0.8.19;

import {Test, console} from "forge-std/Test.sol";
import {ERC20} from "lib/solmate/src/tokens/ERC20.sol";
import {AuctionHouse} from "src/AuctionHouse.sol";
import {Auctioneer} from "src/bases/Auctioneer.sol";
import {FeeManager} from "src/bases/FeeManager.sol";
import {WithModules} from "src/modules/Modules.sol";
import {Auction, AuctionModule} from "src/modules/Auction.sol";
import {Veecode, Keycode, keycodeFromVeecode} from "src/modules/Modules.sol";
import {ICallback} from "src/interfaces/ICallback.sol";
import {Callbacks} from "src/lib/Callbacks.sol";

// Mock token that reverts on zero transfer
contract RevertOnZeroToken is ERC20 {
    constructor(string memory name, string memory symbol, uint8 decimals) ERC20(name, symbol, decimals) {}
    
    function transfer(address to, uint256 amount) public override returns (bool) {
        if (amount == 0) revert("Zero transfer not allowed");
        return super.transfer(to, amount);
    }
    
    function transferFrom(address from, address to, uint256 amount) public override returns (bool) {
        if (amount == 0) revert("Zero transfer not allowed");
        return super.transferFrom(from, to, amount);
    }
}

// Mock auction module for testing
contract MockAuctionModule is AuctionModule {
    mapping(uint96 => Auction.Lot) public lots;
    mapping(uint96 => bool) public settled;
    mapping(uint96 => uint96) public remainingCapacityMap;
    
    function createLot(Auction.Lot memory lot_) external override returns (uint96 lotId) {
        lotId = uint96(1);
        lots[lotId] = lot_;
        remainingCapacityMap[lotId] = lot_.capacity;
    }
    
    function remainingCapacity(uint96 lotId_) external view override returns (uint96) {
        return remainingCapacityMap[lotId_];
    }
    
    function hasEnded(uint96 lotId_) external view override returns (bool) {
        return settled[lotId_];
    }
    
    function settle(uint96 lotId_) external override returns (Auction.Settlement memory, bytes memory) {
        settled[lotId_] = true;
        Auction.Settlement memory settlement;
        settlement.totalIn = lots[lotId_].capacity; // Assume full capacity sold
        settlement.totalOut = lots[lotId_].capacity;
        return (settlement, "");
    }
    
    function claimProceeds(uint96 lotId_) external override returns (uint96, uint96, uint96) {
        return (lots[lotId_].capacity, lots[lotId_].capacity, lots[lotId_].capacity);
    }
    
    function purchase(uint96 lotId_, uint96 amount_, bytes calldata) external pure override returns (uint96, bytes memory) {
        return (amount_, "");
    }
    
    function bid(uint96 lotId_, address bidder_, address referrer_, uint96 amount_, bytes calldata) external pure override returns (uint64) {
        return uint64(1);
    }
    
    function refundBid(uint96 lotId_, uint64 bidId_, address caller_) external pure override returns (uint96) {
        return 0;
    }
    
    function claimBids(uint96 lotId_, uint64[] calldata bidIds_) external pure override returns (Auction.BidClaim[] memory, bytes memory) {
        Auction.BidClaim[] memory claims = new Auction.BidClaim[](0);
        return (claims, "");
    }
}

contract AuctionHouseExploitTest is Test {
    AuctionHouse public auctionHouse;
    MockAuctionModule public auctionModule;
    RevertOnZeroToken public baseToken;
    RevertOnZeroToken public quoteToken;
    
    address public owner = address(0x1);
    address public seller = address(0x2);
    address public curator = address(0x3);
    address public protocol = address(0x4);
    address public permit2 = address(0x5);
    
    uint96 public constant LOT_ID = 1;
    uint96 public constant CAPACITY = 1000e18;
    
    function setUp() public {
        // Deploy contracts
        baseToken = new RevertOnZeroToken("Base Token", "BASE", 18);
        quoteToken = new RevertOnZeroToken("Quote Token", "QUOTE", 18);
        auctionModule = new MockAuctionModule();
        
        // Deploy AuctionHouse
        vm.prank(owner);
        auctionHouse = new AuctionHouse(owner, protocol, permit2);
        
        // Install mock auction module
        vm.prank(owner);
        auctionHouse.installModule(keycodeFromVeecode(bytes7("AUCTION")), address(auctionModule));
        
        // Mint tokens to seller
        baseToken.mint(seller, CAPACITY * 2);
        quoteToken.mint(seller, CAPACITY * 2);
        
        // Approve AuctionHouse to spend seller's tokens
        vm.prank(seller);
        baseToken.approve(address(auctionHouse), type(uint256).max);
        vm.prank(seller);
        quoteToken.approve(address(auctionHouse), type(uint256).max);
    }
    
    function testClaimProceedsWithZeroTransferRevert() public {
        // Create a prefunded batch auction lot
        Auctioneer.LotParams memory lotParams = Auctioneer.LotParams({
            baseToken: baseToken,
            quoteToken: quoteToken,
            capacity: CAPACITY,
            minFillPercent: 0,
            startTime: uint48(block.timestamp),
            endTime: uint48(block.timestamp + 1 hours),
            auctionReference: bytes7("AUCTION"),
            derivativeReference: bytes7(0),
            derivativeParams: "",
            wrapDerivative: false,
            callbacks: ICallback(address(0)),
            funding: CAPACITY // Prefunded
        });
        
        // Create the lot
        vm.prank(seller);
        uint96 lotId = auctionHouse.createLot(lotParams);
        
        // Set curator
        vm.prank(owner);
        auctionHouse.proposeCurator(lotId, curator);
        
        // Curate the lot (this will transfer curator fee)
        vm.prank(curator);
        auctionHouse.curate(lotId, "");
        
        // Settle the auction (fully sold)
        vm.prank(seller);
        auctionHouse.settle(lotId);
        
        // Try to claim proceeds - this should revert due to zero transfer
        vm.prank(seller);
        vm.expectRevert("Zero transfer not allowed");
        auctionHouse.claimProceeds(lotId, "");
        
        console.log("Exploit successful: Seller's quote tokens are locked!");
        console.log("Seller cannot claim proceeds due to revert on zero transfer");
    }
    
    function testShowZeroTransferCalculation() public {
        // Create a prefunded batch auction lot
        Auctioneer.LotParams memory lotParams = Auctioneer.LotParams({
            baseToken: baseToken,
            quoteToken: quoteToken,
            capacity: CAPACITY,
            minFillPercent: 0,
            startTime: uint48(block.timestamp),
            endTime: uint48(block.timestamp + 1 hours),
            auctionReference: bytes7("AUCTION"),
            derivativeReference: bytes7(0),
            derivativeParams: "",
            wrapDerivative: false,
            callbacks: ICallback(address(0)),
            funding: CAPACITY // Prefunded
        });
        
        // Create the lot
        vm.prank(seller);
        uint96 lotId = auctionHouse.createLot(lotParams);
        
        // Set curator
        vm.prank(owner);
        auctionHouse.proposeCurator(lotId, curator);
        
        // Curate the lot
        vm.prank(curator);
        auctionHouse.curate(lotId, "");
        
        // Settle the auction
        vm.prank(seller);
        auctionHouse.settle(lotId);
        
        // Check the calculation that leads to zero transfer
        (uint96 purchased, uint96 sold, uint96 payoutSent) = auctionModule.claimProceeds(lotId);
        
        // Get routing data
        (,,,,, uint96 funding,,,,) = auctionHouse.lot(lotId);
        
        // Calculate prefundingRefund as done in claimProceeds
        uint96 prefundingRefund = funding + payoutSent - sold;
        
        console.log("Purchased:", purchased);
        console.log("Sold:", sold);
        console.log("Payout Sent:", payoutSent);
        console.log("Remaining Funding:", funding);
        console.log("Prefunding Refund:", prefundingRefund);
        
        // Verify that prefundingRefund is zero
        assertEq(prefundingRefund, 0, "Prefunding refund should be zero for fully settled auction");
    }
}