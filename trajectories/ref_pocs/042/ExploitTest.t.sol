pragma solidity ^0.8.28;

import { IOracle } from "../../contracts/interfaces/IOracle.sol";
import { IVaultAdapter } from "../../contracts/interfaces/IVaultAdapter.sol";
import { VaultAdapter } from "../../contracts/oracle/libraries/VaultAdapter.sol";
import { TestDeployer } from "../deploy/TestDeployer.sol";
import { console } from "forge-std/console.sol";

contract POC is TestDeployer {
    VaultAdapter adapter;
    address user_agent;

    function setUp() public {
        _deployCapTestEnvironment();

        _initTestVaultLiquidity(usdVault);
        _initSymbioticVaultsLiquidity(env);

        user_agent = _getRandomAgent();

        vm.startPrank(env.symbiotic.users.vault_admin);
        _symbioticVaultDelegateToAgent(symbioticWethVault, env.symbiotic.networkAdapter, user_agent, 2.385e18);
        vm.stopPrank();

        vm.startPrank(env.users.lender_admin);

        uint256 reservesCount = lender.reservesCount();
        console.log("Reserves Count", reservesCount);

        vm.stopPrank();

        // setup vault adapter
        vm.startPrank(env.users.access_control_admin);
        VaultAdapter adapterImpl = new VaultAdapter();
        adapter = VaultAdapter(_proxy(address(adapterImpl)));
        adapter.initialize(address(accessControl));
        accessControl.grantAccess(adapter.setSlopes.selector, address(adapter), env.users.access_control_admin);
        accessControl.grantAccess(adapter.setLimits.selector, address(adapter), env.users.access_control_admin);
        adapter.setSlopes(address(usdc), IVaultAdapter.SlopeData({ kink: 2e26, slope0: 0.01e27, slope1: 0.03e27 }));
        adapter.setLimits({
            _maxMultiplier: 1e27, // 100%
            _minMultiplier: 1e25, // 1%
            _rate: uint(1e27) / 1 days // 100% / day
         });
        vm.stopPrank();
    }

    function test_submissionValidity() public {
        vm.startPrank(user_agent);
        // utilization rate is set below than the kink ratio
        lender.borrow(address(usdc), 100e6, user_agent);
        assertLt(cUSD.utilization(address(usdc)), 2e26);
        adapter.rate(env.usdVault.capToken, address(usdc));
        // utilization rate is set above than the kink ratio
        lender.borrow(address(usdc), 2600e6, user_agent);
        assertGt(cUSD.utilization(address(usdc)), 2e26);

        // due to rounding issue, utilization rate will not grow because multiplier is not shifted
        _timeTravel(1 days / 2);
        uint256 utilizationRateFirst = adapter.rate(env.usdVault.capToken, address(usdc));
        _timeTravel(1 days / 2);
        uint256 utilizationRateSecond = adapter.rate(env.usdVault.capToken, address(usdc));
        assertEq(utilizationRateFirst, utilizationRateSecond);

        // rounding issue happens for 1 day as well, so we need to advance 1 second further
        _timeTravel(1 days + 1);
        // now the utilization rate is increased
        uint256 utilizationRateThird = adapter.rate(env.usdVault.capToken, address(usdc));
        assertGt(utilizationRateThird, utilizationRateSecond);
    }
}